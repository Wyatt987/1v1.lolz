<script>
/* ---------------------------------------------------
    INITIAL SETUP
----------------------------------------------------*/
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// lighting
const light = new THREE.DirectionalLight(0xffffff, 1);
light.position.set(5,10,8);
scene.add(light);

/* ---------------------------------------------------
    ARENA FLOOR
----------------------------------------------------*/
const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(200,200),
    new THREE.MeshLambertMaterial({ color: 0x3c3c3c })
);
floor.rotation.x = -Math.PI/2;
scene.add(floor);

/* ---------------------------------------------------
    PLAYER
----------------------------------------------------*/
const player = new THREE.Object3D();
player.position.set(0,1.5,5);
scene.add(player);

// Player visible capsule
const body = new THREE.Mesh(
    new THREE.CapsuleGeometry(0.5,1.2,8,16),
    new THREE.MeshStandardMaterial({ color: 0x00ffc8 })
);
body.position.y = -0.1;
player.add(body);

/* ---------------------------------------------------
    INPUT
----------------------------------------------------*/
const keys = {};
document.addEventListener('keydown', e => keys[e.key]=true);
document.addEventListener('keyup', e => keys[e.key]=false);

let buildMode = "wall";
let rotateAmount = 0;

document.addEventListener('keydown', e => {

    // Build type selection
    if (e.key.toLowerCase() === 'z') buildMode = "wall";
    if (e.key.toLowerCase() === 'x') buildMode = "floor";
    if (e.key.toLowerCase() === 'c') buildMode = "ramp";
    if (e.key.toLowerCase() === 'v') buildMode = "cone";

    // Rotate builds
    if (e.key.toLowerCase() === 'r')
        rotateAmount += Math.PI/2;

    // Place build
    if (e.key.toLowerCase() === 'f' || e.key.toLowerCase() === 'q')
        build();
});

/* ---------------------------------------------------
    MOUSE LOOK
----------------------------------------------------*/
document.body.onclick = ()=> document.body.requestPointerLock();

document.addEventListener('mousemove', e=>{
    if (document.pointerLockElement === document.body) {
        player.rotation.y -= e.movementX * 0.002;
        camera.rotation.x -= e.movementY * 0.002;
        camera.rotation.x = Math.max(-1.2, Math.min(1.2, camera.rotation.x));
    }
});

/* ---------------------------------------------------
    SHOOTING SYSTEM
----------------------------------------------------*/
const bullets = [];
document.addEventListener('mousedown', () => shoot());

function shoot(){
    const bullet = new THREE.Mesh(
        new THREE.SphereGeometry(0.1),
        new THREE.MeshBasicMaterial({color:0xff0000})
    );

    bullet.position.copy(camera.position);
    const dir = new THREE.Vector3();
    camera.getWorldDirection(dir);
    bullet.velocity = dir.multiplyScalar(0.8);

    bullets.push(bullet);
    scene.add(bullet);
}

/* ---------------------------------------------------
    BUILDING SYSTEM (Z/X/C/V)
----------------------------------------------------*/
const builds = [];

function build(){
    let geom;
    let mat = new THREE.MeshLambertMaterial({ color: 0x55aaff });

    switch (buildMode) {
        case "wall":
            geom = new THREE.BoxGeometry(3, 3, 0.3);
            break;

        case "floor":
            geom = new THREE.PlaneGeometry(3, 3);
            break;

        case "ramp":
            geom = new THREE.BoxGeometry(3, 1, 3);
            break;

        case "cone":
            geom = new THREE.ConeGeometry(1.8, 3, 4);
            break;
    }

    const obj = new THREE.Mesh(geom, mat);

    const forward = new THREE.Vector3(0, 0, -5)
        .applyAxisAngle(new THREE.Vector3(0, 1, 0), player.rotation.y);

    obj.position.copy(player.position).add(forward);
    obj.rotation.y = player.rotation.y + rotateAmount;

    if (buildMode === "floor") obj.rotation.x = -Math.PI/2;
    if (buildMode === "ramp") obj.rotation.x = -Math.PI/4;
    if (buildMode === "cone") obj.rotation.x = Math.PI;

    builds.push(obj);
    scene.add(obj);
}

/* ---------------------------------------------------
    GAME LOOP
----------------------------------------------------*/
camera.position.set(0,2,0);
camera.rotation.order = "YXZ";

function animate(){
    requestAnimationFrame(animate);

    // Player movement
    const forward = new THREE.Vector3(Math.sin(player.rotation.y),0,Math.cos(player.rotation.y));
    const right = new THREE.Vector3(forward.z,0,-forward.x);

    if (keys['w']) player.position.add(forward.multiplyScalar(-0.12));
    if (keys['s']) player.position.add(forward.multiplyScalar(0.12));
    if (keys['a']) player.position.add(right.multiplyScalar(-0.12));
    if (keys['d']) player.position.add(right.multiplyScalar(0.12));

    // Camera follow behind player
    const camOffset = new THREE.Vector3(0,2,4)
        .applyAxisAngle(new THREE.Vector3(0,1,0), player.rotation.y);

    camera.position.copy(player.position).add(camOffset);
    camera.lookAt(player.position);

    // Bullets update
    for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.position.add(b.velocity);

        if (b.position.length() > 300) {
            scene.remove(b);
            bullets.splice(i, 1);
        }
    }

    renderer.render(scene,camera);
}

animate();
</script>
